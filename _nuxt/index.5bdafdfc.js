import{h as H,s as U,r as b,i as B,j as G,o as i,a as d,u as o,t as g,k as C,b as t,l as z,v as J,m as K,f as $,F as R,p as q}from"./entry.50b0275d.js";import{i as P,g as Q,a as X,b as A,t as Y,j as Z,p as tt,h as et}from"./sync.f768bbb9.js";import{a as nt}from"./likenft.adfb8122.js";import{s as st}from"./sync.da280c3c.js";import{u as lt}from"./wallet.066370b3.js";import"./index.060098c5.js";const at=t("h1",null,"Send NFT",-1),ot={key:0,style:{color:"red"}},rt={key:1,style:{color:"green"}},ut=t("hr",null,null,-1),it={key:2},dt=t("h2",null,"1. Send NFT",-1),ct=t("p",null,[t("label",null,"Enter default memo (optional)")],-1),ft=t("p",null,[t("label",null,[$("Upload NFT CSV ( "),t("a",{href:"https://github.com/likecoin/iscn-nft-tools/blob/master/send-nft/list_example.csv",target:"_blank"}," list.csv "),$(") file: ")])],-1),ht={key:0},gt=t("thead",null,[t("tr",null,[t("td",null,"Class ID"),t("td",null,"Count")])],-1),vt=t("br",null,null,-1),mt=["disabled"],_t={key:3},pt=t("thead",null,[t("tr",null,[t("td",null,"Address"),t("td",null,"Class ID"),t("td",null,"Memo"),t("td",null,"Status")])],-1),wt=["disabled"],xt=H({__name:"index",setup(bt){const V=lt(),{wallet:v,signer:D}=U(V),{connect:M}=V,T=b(1),S=b(""),w=b(!1),I=b(""),r=b([]),c=b([]),N=B(()=>r.value.reduce((e,a)=>(e[a.classId]=(e[a.classId]||0)+1,e),{})),x=B(()=>r.value.reduce((e,a)=>(a.nftId&&(e[a.classId]=e[a.classId]||[],e[a.classId].push(a.nftId)),e),{}));G(w,e=>{e&&(S.value="")});async function j(){try{if(w.value=!0,(!v.value||!D.value)&&await M(),!v.value||!D.value)return;if(!r.value.length)throw new Error("NFT data not exists");const e={};for(let l=0;l<Object.keys(N.value).length;l+=1){const n=Object.keys(N.value)[l],m=N.value[n],{nfts:k}=await P({classId:n,owner:v.value,needCount:m});if(e[n]=k,m>e[n].length)throw new Error(`NFT classId: ${n} (own quantity: ${e[n].length}), Will send ${m} counts, NFT not enough!`);if(x.value[n]){for(let _=0;_<x.value[n].length;_+=1){const h=x.value[n][_],{owner:O}=await Q(n,h);if(O!==v.value)throw new Error(`NFT classId: ${n} nftId:${h} is not owned by sender!`)}e[n]=e[n].filter(_=>!x.value[n].includes(_.id))}}const u=(await X(D.value)).getSigningStargateClient();if(!u)throw new Error("Signing client not exists");const p=r.value.some(l=>l.memo),{accountNumber:s,sequence:E}=await u.getSequence(v.value),F=await u.getChainId();T.value+=1;const f=[];let y=E;for(let l=0;l<r.value.length;l+=1){const n=r.value[l];let m=n.nftId;m||(m=e[n.classId].splice(0,1)[0].id),c.value[l].nftId=m;const k=nt(v.value,n.address,n.classId,m);if(p){const _=await u.sign(v.value,[k],A(1),n.memo||I.value,{accountNumber:s,sequence:y,chainId:F});c.value[l].status="signed",y+=1;try{const h=Y.TxRaw.encode(_).finish(),O=await u.broadcastTx(h,1e3,1e3);c.value[l].status=`broadcasted ${O.transactionHash}`}catch(h){if(h instanceof Z.TimeoutError)c.value[l].status=`broadcasted ${h.txId}`;else throw c.value[l].status=`error ${h.toString()}`,h}}else f.push(k)}if(f.length){const l=await u.signAndBroadcast(v.value,f,A(r.value.length),I.value);for(let n=0;n<r.value.length;n+=1)c.value[n].status=`broadcasted ${l.transactionHash}`}}catch(e){console.error(e),S.value=e.toString()}finally{w.value=!1}}function L(e){var s;if(!(e!=null&&e.target))return;const a=(s=e.target)==null?void 0:s.files;if(!a)return;const[u]=a,p=new FileReader;p.onload=E=>{var F;try{const f=(F=E.target)==null?void 0:F.result;if(typeof f!="string")return;const y=tt(f,{columns:!0});r.value=y,c.value=y}catch(f){console.error(f),S.value=f.toString()}},p.readAsText(u)}function W(){et(st(c.value),"result.csv","text/csv;charset=utf-8;")}return(e,a)=>{var u,p;return i(),d("div",null,[at,o(S)?(i(),d("div",ot,g(o(S)),1)):C("",!0),o(w)?(i(),d("div",rt," Loading... ")):C("",!0),t("div",null,"Steps "+g(o(T))+" / 2",1),ut,o(T)===1?(i(),d("section",it,[dt,t("div",null,[ct,z(t("input",{"onUpdate:modelValue":a[0]||(a[0]=s=>K(I)?I.value=s:null),placeholder:"default memo"},null,512),[[J,o(I)]]),ft,(u=o(r))!=null&&u.length?(i(),d("div",ht,[t("pre",null,"Number of NFT data in CSV:"+g((p=o(r))==null?void 0:p.length),1),$(" Summary "),t("table",null,[gt,t("tbody",null,[(i(!0),d(R,null,q(Object.entries(o(N)),s=>(i(),d("tr",{key:s[0]},[t("td",null,g(s[0]),1),t("td",null,g(s[1]),1)]))),128))])])])):C("",!0),t("input",{type:"file",onChange:L},null,32),vt,t("button",{disabled:o(w),style:{"margin-top":"16px"},onClick:j}," Send ",8,mt)])])):C("",!0),o(T)>1?(i(),d("section",_t,[$(" Result: "),t("table",null,[pt,t("tbody",null,[(i(!0),d(R,null,q(o(c),s=>(i(),d("tr",{key:s[0]},[t("td",null,g(s.address),1),t("td",null,g(s.classId),1),t("td",null,g(s.memo),1),t("td",null,g(s.status),1)]))),128))])]),t("button",{disabled:o(w),onClick:W}," Download NFT result csv ",8,wt)])):C("",!0)])}}});export{xt as default};
