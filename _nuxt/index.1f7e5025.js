import{i as H,s as U,r as S,j as V,k as G,o as i,b as d,u as o,t as h,l as C,e as t,m as z,v as J,p as K,h as q,F as B,q as R}from"./entry.010ef449.js";import{j as P,g as Q,a as X,b as A,t as Y,k as Z,p as tt,h as et}from"./sync.afa50c2a.js";import{a as nt}from"./likenft.5056a1d7.js";import{s as st}from"./sync.da280c3c.js";import{u as lt}from"./wallet.7c002462.js";const at=t("h1",null,"Send NFT",-1),ot={key:0,style:{color:"red"}},rt={key:1,style:{color:"green"}},ut=t("hr",null,null,-1),it={key:2},dt=t("h2",null,"1. Send NFT",-1),ct=t("p",null,[t("label",null,"Enter default memo (optional)")],-1),ft=t("p",null,[t("label",null,"Upload NFT CSV (list.csv) file: ")],-1),gt={key:0},ht=t("thead",null,[t("tr",null,[t("td",null,"Class ID"),t("td",null,"Count")])],-1),vt=t("br",null,null,-1),mt=["disabled"],_t={key:3},pt=t("thead",null,[t("tr",null,[t("td",null,"Address"),t("td",null,"Class ID"),t("td",null,"Memo"),t("td",null,"Status")])],-1),wt=["disabled"],Nt=H({__name:"index",setup(St){const O=lt(),{wallet:v,signer:$}=U(O),{connect:M}=O,T=S(1),b=S(""),w=S(!1),I=S(""),r=S([]),c=S([]),N=V(()=>r.value.reduce((e,a)=>(e[a.classId]=(e[a.classId]||0)+1,e),{})),F=V(()=>r.value.reduce((e,a)=>(a.nftId&&(e[a.classId]=e[a.classId]||[],e[a.classId].push(a.nftId)),e),{}));G(w,e=>{e&&(b.value="")});async function j(){try{if(w.value=!0,(!v.value||!$.value)&&await M(),!v.value||!$.value)return;if(!r.value.length)throw new Error("NFT data not exists");const e={};for(let l=0;l<Object.keys(N.value).length;l+=1){const n=Object.keys(N.value)[l],m=N.value[n],{nfts:k}=await P({classId:n,owner:v.value,needCount:m});if(e[n]=k,m>e[n].length)throw new Error(`NFT classId: ${n} (own quantity: ${e[n].length}), Will send ${m} counts, NFT not enough!`);if(F.value[n]){for(let _=0;_<F.value[n].length;_+=1){const g=F.value[n][_],{owner:E}=await Q(n,g);if(E!==v.value)throw new Error(`NFT classId: ${n} nftId:${g} is not owned by sender!`)}e[n]=e[n].filter(_=>!F.value[n].includes(_.id))}}const u=(await X($.value)).getSigningStargateClient();if(!u)throw new Error("Signing client not exists");const p=r.value.some(l=>l.memo),{accountNumber:s,sequence:D}=await u.getSequence(v.value),x=await u.getChainId();T.value+=1;const f=[];let y=D;for(let l=0;l<r.value.length;l+=1){const n=r.value[l];let m=n.nftId;m||(m=e[n.classId].splice(0,1)[0].id),c.value[l].nftId=m;const k=nt(v.value,n.address,n.classId,m);if(p){const _=await u.sign(v.value,[k],A(1),n.memo||I.value,{accountNumber:s,sequence:y,chainId:x});c.value[l].status="signed",y+=1;try{const g=Y.TxRaw.encode(_).finish(),E=await u.broadcastTx(g,1e3,1e3);c.value[l].status=`broadcasted ${E.transactionHash}`}catch(g){if(g instanceof Z.TimeoutError)c.value[l].status=`broadcasted ${g.txId}`;else throw c.value[l].status=`error ${g.toString()}`,g}}else f.push(k)}if(f.length){const l=await u.signAndBroadcast(v.value,f,A(r.value.length),I.value);for(let n=0;n<r.value.length;n+=1)c.value[n].status=`broadcasted ${l.transactionHash}`}}catch(e){console.error(e),b.value=e.toString()}finally{w.value=!1}}function L(e){var s;if(!(e!=null&&e.target))return;const a=(s=e.target)==null?void 0:s.files;if(!a)return;const[u]=a,p=new FileReader;p.onload=D=>{var x;try{const f=(x=D.target)==null?void 0:x.result;if(typeof f!="string")return;const y=tt(f,{columns:!0});r.value=y,c.value=y}catch(f){console.error(f),b.value=f.toString()}},p.readAsText(u)}function W(){et(st(c.value),"result.csv","text/csv;charset=utf-8;")}return(e,a)=>{var u,p;return i(),d("div",null,[at,o(b)?(i(),d("div",ot,h(o(b)),1)):C("",!0),o(w)?(i(),d("div",rt," Loading... ")):C("",!0),t("div",null,"Steps "+h(o(T))+" / 2",1),ut,o(T)===1?(i(),d("section",it,[dt,t("div",null,[ct,z(t("input",{"onUpdate:modelValue":a[0]||(a[0]=s=>K(I)?I.value=s:null),placeholder:"default memo"},null,512),[[J,o(I)]]),ft,(u=o(r))!=null&&u.length?(i(),d("div",gt,[t("pre",null,"Number of NFT data in CSV:"+h((p=o(r))==null?void 0:p.length),1),q(" Summary "),t("table",null,[ht,t("tbody",null,[(i(!0),d(B,null,R(Object.entries(o(N)),s=>(i(),d("tr",{key:s[0]},[t("td",null,h(s[0]),1),t("td",null,h(s[1]),1)]))),128))])])])):C("",!0),t("input",{type:"file",onChange:L},null,32),vt,t("button",{disabled:o(w),style:{"margin-top":"16px"},onClick:j}," Send ",8,mt)])])):C("",!0),o(T)>1?(i(),d("section",_t,[q(" Result: "),t("table",null,[pt,t("tbody",null,[(i(!0),d(B,null,R(o(c),s=>(i(),d("tr",{key:s[0]},[t("td",null,h(s.address),1),t("td",null,h(s.classId),1),t("td",null,h(s.memo),1),t("td",null,h(s.status),1)]))),128))])]),t("button",{disabled:o(w),onClick:W}," Download NFT result csv ",8,wt)])):C("",!0)])}}});export{Nt as default};
