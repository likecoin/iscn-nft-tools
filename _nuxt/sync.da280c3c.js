const J=".".charCodeAt(0),B=/\\(\\)?/g,R=RegExp(`[^.[\\]]+|\\[(?:([^"'][^[]*)|(["'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))`,"g"),V=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,D=/^\w*$/,L=function(t){return Object.prototype.toString.call(t)},N=function(t){const e=typeof t;return e==="symbol"||e==="object"&&t&&L(t)==="[object Symbol]"},k=function(t,e){if(Array.isArray(t))return!1;const i=typeof t;return i==="number"||i==="symbol"||i==="boolean"||!t||N(t)?!0:D.test(t)||!V.test(t)||e!=null&&t in Object(e)},Q=function(t){const e=[];return t.charCodeAt(0)===J&&e.push(""),t.replace(R,function(i,r,n,s){let f=i;n?f=s.replace(B,"$1"):r&&(f=r.trim()),e.push(f)}),e},Y=function(t,e){return Array.isArray(t)?t:k(t,e)?[t]:Q(t)},M=function(t){if(typeof t=="string"||N(t))return t;const e=`${t}`;return e=="0"&&1/t==-INFINITY?"-0":e},F=function(t,e){e=Y(e,t);let i=0;const r=e.length;for(;t!=null&&i<r;)t=t[M(e[i++])];return i&&i===r?t:void 0},U=function(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)},x=function(t){if(t==null)return[void 0,void 0];if(typeof t!="object")return[Error('Invalid option "columns": expect an array or an object')];if(Array.isArray(t)){const e=[];for(const i of t)if(typeof i=="string")e.push({key:i,header:i});else if(typeof i=="object"&&i!==null&&!Array.isArray(i)){if(!i.key)return[Error('Invalid column definition: property "key" is required')];i.header===void 0&&(i.header=i.key),e.push(i)}else return[Error("Invalid column definition: expect a string or an object")];t=e}else{const e=[];for(const i in t)e.push({key:i,header:t[i]});t=e}return[void 0,t]};class h extends Error{constructor(e,i,...r){Array.isArray(i)&&(i=i.join(" ")),super(i),Error.captureStackTrace!==void 0&&Error.captureStackTrace(this,h),this.code=e;for(const n of r)for(const s in n){const f=n[s];this[s]=Buffer.isBuffer(f)?f.toString():f==null?f:JSON.parse(JSON.stringify(f))}}}const z=function(t){return t.replace(/([A-Z])/g,function(e,i){return"_"+i.toLowerCase()})},w=function(t){const e={};for(const n in t)e[z(n)]=t[n];if(e.bom===void 0||e.bom===null||e.bom===!1)e.bom=!1;else if(e.bom!==!0)return[new h("CSV_OPTION_BOOLEAN_INVALID_TYPE",["option `bom` is optional and must be a boolean value,",`got ${JSON.stringify(e.bom)}`])];if(e.delimiter===void 0||e.delimiter===null)e.delimiter=",";else if(Buffer.isBuffer(e.delimiter))e.delimiter=e.delimiter.toString();else if(typeof e.delimiter!="string")return[new h("CSV_OPTION_DELIMITER_INVALID_TYPE",["option `delimiter` must be a buffer or a string,",`got ${JSON.stringify(e.delimiter)}`])];if(e.quote===void 0||e.quote===null)e.quote='"';else if(e.quote===!0)e.quote='"';else if(e.quote===!1)e.quote="";else if(Buffer.isBuffer(e.quote))e.quote=e.quote.toString();else if(typeof e.quote!="string")return[new h("CSV_OPTION_QUOTE_INVALID_TYPE",["option `quote` must be a boolean, a buffer or a string,",`got ${JSON.stringify(e.quote)}`])];if((e.quoted===void 0||e.quoted===null)&&(e.quoted=!1),e.escape_formulas===void 0||e.escape_formulas===null)e.escape_formulas=!1;else if(typeof e.escape_formulas!="boolean")return[new h("CSV_OPTION_ESCAPE_FORMULAS_INVALID_TYPE",["option `escape_formulas` must be a boolean,",`got ${JSON.stringify(e.escape_formulas)}`])];if((e.quoted_empty===void 0||e.quoted_empty===null)&&(e.quoted_empty=void 0),e.quoted_match===void 0||e.quoted_match===null||e.quoted_match===!1?e.quoted_match=null:Array.isArray(e.quoted_match)||(e.quoted_match=[e.quoted_match]),e.quoted_match)for(const n of e.quoted_match){const s=typeof n=="string",f=n instanceof RegExp;if(!s&&!f)return[Error(`Invalid Option: quoted_match must be a string or a regex, got ${JSON.stringify(n)}`)]}if((e.quoted_string===void 0||e.quoted_string===null)&&(e.quoted_string=!1),(e.eof===void 0||e.eof===null)&&(e.eof=!0),e.escape===void 0||e.escape===null)e.escape='"';else if(Buffer.isBuffer(e.escape))e.escape=e.escape.toString();else if(typeof e.escape!="string")return[Error(`Invalid Option: escape must be a buffer or a string, got ${JSON.stringify(e.escape)}`)];if(e.escape.length>1)return[Error(`Invalid Option: escape must be one character, got ${e.escape.length} characters`)];(e.header===void 0||e.header===null)&&(e.header=!1);const[i,r]=x(e.columns);if(i!==void 0)return[i];if(e.columns=r,(e.quoted===void 0||e.quoted===null)&&(e.quoted=!1),(e.cast===void 0||e.cast===null)&&(e.cast={}),(e.cast.bigint===void 0||e.cast.bigint===null)&&(e.cast.bigint=n=>""+n),(e.cast.boolean===void 0||e.cast.boolean===null)&&(e.cast.boolean=n=>n?"1":""),(e.cast.date===void 0||e.cast.date===null)&&(e.cast.date=n=>""+n.getTime()),(e.cast.number===void 0||e.cast.number===null)&&(e.cast.number=n=>""+n),(e.cast.object===void 0||e.cast.object===null)&&(e.cast.object=n=>JSON.stringify(n)),(e.cast.string===void 0||e.cast.string===null)&&(e.cast.string=function(n){return n}),e.on_record!==void 0&&typeof e.on_record!="function")return[Error('Invalid Option: "on_record" must be a function.')];if(e.record_delimiter===void 0||e.record_delimiter===null)e.record_delimiter=`
`;else if(Buffer.isBuffer(e.record_delimiter))e.record_delimiter=e.record_delimiter.toString();else if(typeof e.record_delimiter!="string")return[Error(`Invalid Option: record_delimiter must be a buffer or a string, got ${JSON.stringify(e.record_delimiter)}`)];switch(e.record_delimiter){case"auto":e.record_delimiter=null;break;case"unix":e.record_delimiter=`
`;break;case"mac":e.record_delimiter="\r";break;case"windows":e.record_delimiter=`\r
`;break;case"ascii":e.record_delimiter="";break;case"unicode":e.record_delimiter="\u2028";break}return[void 0,e]},K=Buffer.from([239,187,191]),Z=function(t,e,i){return{options:t,state:e,info:i,__transform:function(r,n){if(!Array.isArray(r)&&typeof r!="object")return Error(`Invalid Record: expect an array or an object, got ${JSON.stringify(r)}`);if(this.info.records===0){if(Array.isArray(r)){if(this.options.header===!0&&this.options.columns===void 0)return Error("Undiscoverable Columns: header option requires column option or object records")}else if(this.options.columns===void 0){const[c,u]=x(Object.keys(r));if(c)return;this.options.columns=u}}if(this.info.records===0){this.bom(n);const c=this.headers(n);if(c)return c}try{this.options.on_record&&this.options.on_record(r,this.info.records)}catch(c){return c}let s,f;if(this.options.eof){if([s,f]=this.stringify(r),s)return s;if(f===void 0)return;f=f+this.options.record_delimiter}else{if([s,f]=this.stringify(r),s)return s;if(f===void 0)return;(this.options.header||this.info.records)&&(f=this.options.record_delimiter+f)}this.info.records++,n(f)},stringify:function(r,n=!1){if(typeof r!="object")return[void 0,r];const{columns:s}=this.options,f=[];if(Array.isArray(r)){s&&r.splice(s.length);for(let u=0;u<r.length;u++){const d=r[u],[l,o]=this.__cast(d,{index:u,column:u,records:this.info.records,header:n});if(l)return[l];f[u]=[o,d]}}else for(let u=0;u<s.length;u++){const d=F(r,s[u].key),[l,o]=this.__cast(d,{index:u,column:s[u].key,records:this.info.records,header:n});if(l)return[l];f[u]=[o,d]}let c="";for(let u=0;u<f.length;u++){let d,l,[o,O]=f[u];if(typeof o=="string")d=this.options;else if(U(o)){if(d=o,o=d.value,delete d.value,typeof o!="string"&&o!==void 0&&o!==null&&l)return[Error(`Invalid Casting Value: returned value must return a string, null or undefined, got ${JSON.stringify(o)}`)];if(d={...this.options,...d},[l,d]=w(d),l!==void 0)return[l]}else if(o==null)d=this.options;else return[Error(`Invalid Casting Value: returned value must return a string, an object, null or undefined, got ${JSON.stringify(o)}`)];const{delimiter:E,escape:p,quote:a,quoted:$,quoted_empty:_,quoted_string:S,quoted_match:b,record_delimiter:j,escape_formulas:T}=d;if(o===""&&O===""){let m=b&&b.filter(y=>typeof y=="string"?o.indexOf(y)!==-1:y.test(o));m=m&&m.length>0,(m||_===!0||S===!0&&_!==!1)===!0&&(o=a+o+a),c+=o}else if(o){if(typeof o!="string")return[Error(`Formatter must return a string, null or undefined, got ${JSON.stringify(o)}`)];const m=E.length&&o.indexOf(E)>=0,A=a!==""&&o.indexOf(a)>=0,y=o.indexOf(p)>=0&&p!==a,P=o.indexOf(j)>=0,C=S&&typeof O=="string";let q=b&&b.filter(g=>typeof g=="string"?o.indexOf(g)!==-1:g.test(o));q=q&&q.length>0,T&&["=","+","-","@","	","\r"].includes(o[0])&&(o=`'${o}`);const I=A===!0||m||P||$||C||q;if(I===!0&&y===!0){const g=p==="\\"?new RegExp(p+p,"g"):new RegExp(p,"g");o=o.replace(g,p+p)}if(A===!0){const g=new RegExp(a,"g");o=o.replace(g,p+a)}I===!0&&(o=a+o+a),c+=o}else(_===!0||O===""&&S===!0&&_!==!1)&&(c+=a+a);u!==f.length-1&&(c+=E)}return[void 0,c]},bom:function(r){this.options.bom===!0&&r(K)},headers:function(r){if(this.options.header===!1||this.options.columns===void 0)return;let n,s=this.options.columns.map(f=>f.header);if(this.options.eof?([n,s]=this.stringify(s,!0),s+=this.options.record_delimiter):[n,s]=this.stringify(s),n)return n;r(s)},__cast:function(r,n){const s=typeof r;try{return s==="string"?[void 0,this.options.cast.string(r,n)]:s==="bigint"?[void 0,this.options.cast.bigint(r,n)]:s==="number"?[void 0,this.options.cast.number(r,n)]:s==="boolean"?[void 0,this.options.cast.boolean(r,n)]:r instanceof Date?[void 0,this.options.cast.date(r,n)]:s==="object"&&r!==null?[void 0,this.options.cast.object(r,n)]:[void 0,r,r]}catch(f){return[f]}}}},G=function(t,e={}){const i=[],[r,n]=w(e);if(r!==void 0)throw r;const c=Z(n,{stop:!1},{records:0});for(const u of t){const d=c.__transform(u,function(l){i.push(l)});if(d!==void 0)throw d}if(i.length===0){c.bom(d=>{i.push(d)});const u=c.headers(d=>{i.push(d)});if(u!==void 0)throw u}return i.join("")};export{G as s};
